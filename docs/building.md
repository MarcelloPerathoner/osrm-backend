# Building OSRM from Source

## Prerequisites

Check out the repository:

```bash
git clone https://github.com/Project-OSRM/osrm-backend.git
cd osrm-backend
```

The project depends on external libraries. You can install those dependencies with a
package manager (Conan) or install them  manually (apt-get).

## Build manually

Install dependencies:

```bash
sudo apt-get install -y libbz2-dev libxml2-dev libzip-dev liblua5.2-dev libtbb-dev libboost-all-dev
npm ci --ignore-scripts
```
Note: here `ci` means "clean install" and not "continuous integration".

Build:

```bash
cmake -B build/Release
make -C build/Release -j 16
```

Replace `16` with the number of cores you have. The binaries will be in `build/Release`.  Proceed with [running the tests](#Run-tests).

A list of arguments for cmake:

| Argument               | Default   | Description                                  |
| ---------------------- | --------- | -------------------------------------------- |
| `-DMAKE_BUILD_TYPE`    | `Release` | Specify the build type: `Release` or `Debug` |
| `-DBUILD_SHARED_LIBS`  | `OFF`     | Build with shared libs: `ON` or `OFF`.       |
| `-DBUILD_NODE_PACKAGE` | `OFF`     | Build the Node package: `ON` or `OFF`.       |

### Node Package

If you want to build the Node package, you should use:

```bash
cmake -B build/Release -DBUILD_NODE_PACKAGE=ON
make -C build/Release -j 16
cmake --install build/Release --component node_osrm
scripts/ci/build_node_package.sh
```

The node binaries should be in `build/nodejs/lib/binding_napi_v8`.

## Build using Conan

First install Conan. You have to do this only once.

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements*.txt
export CONAN_HOME=`pwd`/.conan2
conan profile detect --force
```

Then say:

```bash
source .venv/bin/activate
export CONAN_HOME=`pwd`/.conan2
conan build -pr home --build=missing
```

N.B. you need to enter the `source` and `export` commands only once per shell
invocation.

A list of arguments for Conan:

| Argument          | Default   | Description                                  |
| ----------------- | --------- | -------------------------------------------- |
| `-s build_type`   | `Release` | Specify the build type: `Release` or `Debug` |
| `-o shared`       | `False`   | Build with shared libs: `True` or `False`.   |
| `-o node_package` | `False`   | Build the Node package: `True` or `False`.   |

The binaries are now in `build/Release`.

### Node Package

If you want to build the Node package, you should use:

```bash
conan build -pr home --build=missing -o node_package=True
cmake --install build/Release --component node_osrm
scripts/ci/build_node_package.sh
```

The node binaries should be in `build/nodejs/lib/binding_napi_v8`.

## Run tests

To run the unit tests:

```bash
make -C build/Release -j 16 tests benchmarks
make -C test/data
ctest --test-dir build/Release/unit_tests/
```

To run the Cucumber tests:

```bash
npm test -- --parallel 16
```

## The Build Process

The `build` directory is a hardcoded 'well-known' location for bootstrapping build- and
runtime configurations.  The `build` directory will be used for communication between
the build toolchain stages even if the actual build of binaries should take place elsewhere.

Conan puts `conan.env` and Cmake puts `osrm-run.env` there.  `.env` files should only
contain `KEY=VALUE` pairs so they can safely be sourced or piped into `$GITHUB_ENV`.

#### build/conan.env

The file `build/conan.env`, generated by Conan, can be sourced to obtain information
about the build environment setup by Conan.  Usage: `source build/osrm-run.env`. It is
also handy on github CI, usage: `cat build/osrm-run.env >> $GIHUB_ENV`. It contains:

| Shell Variable         | Description                                                                 |
| ---------------------- | --------------------------------------------------------------------------- |
| `CONAN_GENERATORS_DIR` | The location where `conan-build-env.sh` and `conan-run-env.sh` are emitted. |
| `CONAN_BUILD_DIR`      | The build directory Cmake should use.                                       |
| `CONAN_CMAKE_PRESET`   | The preset Cmake should use for building.                                   |
| `CONAN_LIBRARY_PATH`   | The search path for the libraries.                                          |

This file is only present in Conan builds.  After running Conan and sourcing this file
you can call Cmake like this: `cmake -B $CONAN_BUILD_DIR --preset $CONAN_CMAKE_PRESET`


#### build/osrm-run.env

The file `build/osrm-run-env.sh`, generated by Cmake, can be sourced to setup an environment
in which the built binaries can be run. Usage: `source build/osrm-run-env.sh`. It contains:

| Shell Variable              | Description                                          |
| --------------------------- | ---------------------------------------------------- |
| `OSRM_BUILD_DIR`            | The directory where the OSRM binaries will be built. |
| `OSRM_UNIT_TESTS_BUILD_DIR` | The directory where the unit tests will be built.    |
| `OSRM_BENCHMARKS_BUILD_DIR` | The directory where the benchmarks will be built.    |
| `OSRM_NODEJS_BUILD_DIR`     | The directory where the node bindings will be built. |
