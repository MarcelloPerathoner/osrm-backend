The OSRM Build Process Explained
================================

.. tip::

    To learn more about the build process, start with studying these files:

    - `/CMakeLists.txt`
    - `/conanfile.py`
    - `.github/workflows/osrm-backend.yml`
    - all files under `.github/actions`
    - `scripts/ci/decode_matrix.py`


The Complication
----------------

The build must work with most of these combinations:

======== ======= ======= ======= ======== ====== =======
Location OS      Deps    Builder Compiler Linker Type
======== ======= ======= ======= ======== ====== =======
home     Linux   Conan   Make    clang    static Release
github   macOS   apt-get Ninja   gcc      shared Debug
\        Windows \       MSBuild msvc     \      \
======== ======= ======= ======= ======== ====== =======


.. mermaid::

    flowchart TD

        subgraph github [Github]
        direction TB;
            gh_decode[decode_matrix.py]
            gh_presets@{ shape: doc, label: "/<br>CMakePresets.json" }
            gh_apt_get[apt-get install]
            gh_conan[conan install]
            gh_co_presets@{ shape: doc, label: "generators/<br>CMakePresets.json" }
            gh_cm_conf[cmake]
            gh_cm_build[cmake --build]
        end

        gh_decode-->gh_presets-->gh_apt_get--->gh_cm_conf-->gh_cm_build

        gh_presets-->gh_conan-->gh_co_presets-->gh_cm_conf

        subgraph co_build [Conan build]
        direction TB;
            co_install[conan install]
            co_presets@{ shape: doc, label: "generators/<br>CMakePresets.json" }
            co_cm_conf[cmake]
            co_cm_build[cmake --build]
        end

        co_install-->co_presets-->co_cm_conf-->co_cm_build

        subgraph man_build [Manual build]
        direction TB;
            man_apt_get[apt-get install]
            man_cm_conf[cmake]
            man_cm_build[cmake --build]
        end

        man_apt_get-->man_cm_conf-->man_cm_build


Communication between build stages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The `build` directory is a hardcoded 'well-known' location.  The `build` directory is
used for communication between the stages of the build toolchain even if the actual
build of the binaries should take place in `build/Release`, `build/Debug`, or elsewhere.
As the build progresses, more and more information becomes available in `build/`.

================== ==================== ==============================
Program            produces             and
================== ==================== ==============================
`decode_matrix.py` `build/matrix.env`   `/CMakePresets.json`
`conan`            `build/conan.env`    `generators/CMakePresets.json`
`cmake`            `build/osrm-run.env` `build/osrm-run-env.sh`
================== ==================== ==============================

The `.env` files only contain `KEY=VALUE` pairs, so that they can be safely sourced into
a shell, or piped into `$GITHUB_ENV`. `CMakePresets.json` files are consumed by `cmake`
(and also by `conan`). The scripts `build/osrm-run-env.sh` is a convenient way to source
the whole environment in one step.

There is a gotcha: if the `file.env` file contains a `KEY="Value with spaces"` pair
(note the quotes), `cat file.env >> $GITHUB_ENV` *will not* remove those quotes. But
`source file.env` *will* remove those quotes.

build/matrix.env
................

This file will exist only on github. It contains all information extracted from the
github matrix. Its main use is for piping into `$GITHUB_ENV` to make the environment
available to the following job steps.

build/conan.env
...............

This file is generated by Conan during the install stage. Use it if you want to
do a `conan install ...` and then switch to `cmake ...`.

============================= =====================================================
Environment Variable          Description
============================= =====================================================
`CMAKE_CONFIGURE_PRESET_NAME` The preset `cmake` should use for configure.
`CMAKE_BUILD_PRESET_NAME`     The preset `cmake --build` should use.
`CMAKE_TEST_PRESET_NAME`      The preset `ctest` should use.
`CONAN_GENERATORS_DIR`        Where `CMakePresets.json` is emitted. (for debugging)
`OSRM_CONFIG`                 The chosen config: `Release` or `Debug`
============================= =====================================================

build/conan-run-env.sh
......................

This file is generated by Conan during the install stage. Source it to obtain the paths
to all libraries provided by Conan.

==================== ===================================================
Environment Variable Description
==================== ===================================================
`LD_LIBRARY_PATH`    The path to the libraries built by Conan. (Linux)
`DYLD_LIBRARY_PATH`  The path to the libraries built by Conan. (macOS)
`PATH`               The path to the libraries built by Conan. (Windows)
==================== ===================================================

build/osrm-run.env
..................

This file is generated by `cmake` during the configure stage.

=========================== ========================================================
Environment Variable        Description
=========================== ========================================================
`OSRM_BUILD_DIR`            The directory where the OSRM binaries will be built.
`OSRM_UNIT_TESTS_BUILD_DIR` The directory where the unit tests will be built.
`OSRM_BENCHMARKS_BUILD_DIR` The directory where the benchmarks will be built.
`OSRM_NODEJS_BUILD_DIR`     The directory where the node bindings will be built.
`OSRM_NODEJS_INSTALL_DIR`   The directory where the node bindings will be installed.
`OSRM_TEST_DATA_DIR`        The directory containing the curated test data.
=========================== ========================================================

Note: multi-config generators (like Visual Studio or Xcode) generate the artifacts in a
`Release` or `Debug` subdirectory of the `build` directory. The `OSRM_*_BUILD_DIR`
variables always include these subdirectories and point to the location of the files.

build/osrm-run-env.sh
.....................

The file `build/osrm-run-env.sh` can be sourced to setup a runtime environment for the
built binaries. It sources all of the files mentioned above and exports their variables.
